<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Conway's game of life</title>
        <style>
            * {
                box-sizing:border-box;
            }
            canvas{
                background:#efefef;
                cursor:pointer;
            }
            
            textarea{
                width:620px;
                height:51px;
                color:#000;
                font-family:monospace;
            }
            textarea::placeholder{
                color:#888;
                font-style:italic;
            }
            canvas,i{
                display:block;
            }
            #seperator{
                display:block;
                height:50px;
            }
            button, select, input{
                border-radius:4px;
                border:1px solid black;
                cursor:pointer;
            }
            button::first-letter {
                text-decoration: underline;
            }
            #next{
                background:#aee;
            }
            #rand{
                background:#e0f;
            }
            #clear{
                background:#ff0;
            }
            #start{
                background:#0cf600;
            }
            #stop{
                background:#ff511c;
            }
            #apply{
                background:#fa0;
            }
            #spacer{
                height:70px;
                visibility:hidden;
            }
        </style>
    </head>
    <body>
    <canvas onclick="toggle(event, this)"></canvas>
    
    <button id="next">Next</button>
    <button id="rand">Randomize</button>
    <button id="clear">Clear</button>
    <button id="start">Start</button>
    <input id="speed" type="range" min="0" max="290" value="150">
    <button id="apply">Apply</button>
    <select id="pattern"></select>
    <br>
    <br>
    <textarea id="eq" placeholder="Type a JavaScript expression..." spellcheck="false" autoCapitalize="false">let d = 4, corners = 1;/* Try different values of d */
    /* I really like 46, 42, 40, 38, 36, 24, 20 */
    /* I like 49, 44, 34, 29, 28, 27, 26, 25, 21, 19 */
    /* My favorite is (d = 4, corners = 1) */
x -= Math.floor(w/2); y -= Math.floor(h/2);
return isIn(x, y, d-1) && (x + y == 0 || x == y) ||
    corners && isIn(x, y, d) && !isIn(x, y, d-1) &&
    (x < 0 && y <= 2-d && y > -d || x > 0 && y >= d-2 && y < d ||
     y > 0 && x <= 2-d && x > -d || y < 0 && x >= d-2 && x < d);</textarea>
     <i>The variables <code>x</code>, <code>y</code>, <code>w</code>, <code>h</code>, <code>number</code>, <code>live</code> and <code>function&nbsp;isIn(testX,&nbsp;testY,&nbsp;rectStartX,&nbsp;rectStartY,&nbsp;rectWidth,&nbsp;rectHeight)</code> are available</i>
    <div id="spacer"></div>
    <script>
/************************/
/**/ let boxSize = 6; /**/
/************************/
/* variables */
let buttons  = document.querySelectorAll("button");
let nextB    = document.querySelector("#next"   );
let randB    = document.querySelector("#rand"   );
let clearB   = document.querySelector("#clear"  );
let startB   = document.querySelector("#start"  );
let applyB   = document.querySelector("#apply"  );
let runSpeed = document.querySelector("#speed"  );
let pattern  = document.querySelector("#pattern");
let eq = document.querySelector("#eq");
let canvas = document.querySelector("canvas");
let c = canvas.getContext("2d");

let boxes = new Map(), newBoxes = new Map(), possibleNew = new Map();
let numW = 227, numH = 125, w, h;
let min = Math.min, max = Math.max, random = Math.random;

canvas.setAttribute("width", (w = numW*boxSize+1) + "px");
canvas.setAttribute("height", (h = numH*boxSize+1) + "px");

for(let x = 0; x < numW; x++){
    for(let y = 0; y < numH; y++){
        if (Math.random() < 0.5) { boxes.set(`${x} ${y}`, {x: x, y: y}); }
    }
}

function isIn(x, y, x2, y2, w, h){
    switch(arguments.length){
        case 3:
            return x >= -x2 && y >= -x2 && x <= x2 && y <= x2;
        case 4:
            return x >= -x2 && y >= -y2 && x <= x2 && y <= y2;
        case 5:
            return x >= x2 && y >= y2 && x <= w + x2 && y <= w + y2;
        case 6:
            return x >= x2 && y >= y2 && x <= w + x2 && y <= h + y2;
        default:
            return false;
    }
}

function drawBoxes(){
    for(let x = 0; x < numW; x++){
        for(let y = 0; y < numH; y++){
            c.fillStyle = boxes.has(`${x} ${y}`)? "#308aff" : "#efefef";
            c.fillRect(x*boxSize, y*boxSize, boxSize, boxSize);
        }
    }
    
    c.fillStyle = "#000";
    for(let y = 0; y <= numH; y++){
        c.fillRect(0, y*boxSize, w, 1);
    }
    for(let x = 0; x <= numW; x++){
        c.fillRect(x*boxSize, 0, 1, h);
    }
}

function toggle(event, canvas){
    let rect = canvas.getBoundingClientRect();
    let x = Math.floor((event.clientX - rect.left) / boxSize);
    let y = Math.floor((event.clientY - rect.top ) / boxSize);
    
    if (boxes.has(`${x} ${y}`)) {
        boxes.delete(`${x} ${y}`);
    } else {
        boxes.set(`${x} ${y}`, {x: x, y: y});
    }
    
    drawBoxes();
}

let positions = [
    {x: -1, y: -1},
    {x: +0, y: -1},
    {x: +1, y: -1},
    {x: -1, y: +0},
    {x: +1, y: +0},
    {x: -1, y: +1},
    {x: +0, y: +1},
    {x: +1, y: +1}
];

function countLiveNeighbors(i, j){
    let count = 0;
    
    function addPosition(pos){
        let x = i+pos.x, y = j+pos.y;
        
        if(x in boxes && boxes[x][y]){
            count++;
        }
    }
    
    positions.forEach(addPosition);
    
    return count;
}

function next(){
    newBoxes.clear();
    possibleNew.clear();

    function forEachCell(pos) {
        let neighbors = 0;
        for (let i = positions.length; i-- > 0;) {
            let x = pos.x + positions[i].x;
            let y = pos.y + positions[i].y;
            
            if (boxes.has(`${x} ${y}`)) {
                neighbors++;
            } else if (possibleNew.has(`${x} ${y}`)) {
                possibleNew.get(`${x} ${y}`).neighbors++;
            } else {
                possibleNew.set(`${x} ${y}`, {x: x, y: y, neighbors: 1});
            }
        }
        
        if (neighbors >= 2 && neighbors <= 3) {
            newBoxes.set(`${pos.x} ${pos.y}`, {x: pos.x, y: pos.y});
        }
    }
    boxes.forEach(forEachCell);

    function forPossibleNewCells(pos) {
        if (pos.neighbors === 3) {
            newBoxes.set(`${pos.x} ${pos.y}`, {x: pos.x, y: pos.y});
        }
    }
    possibleNew.forEach(forPossibleNewCells);
    
    [boxes, newBoxes] = [newBoxes, boxes];
    
    drawBoxes();
}

function rand(){
    boxes.clear();

    for(let x = 0; x < numW; x++){
        for(let y = 0; y < numH; y++){
            if (Math.random() < 0.5) {
                boxes.set(`${x} ${y}`, {x: x, y: y});
            }
        }
    }
    
    drawBoxes();
}

function clear(){
    boxes.clear();
    drawBoxes();
}

let running = false;
let curTimer = null;
function run(){
    if(running){
        next();
        curTimer = setTimeout(run, 300 - runSpeed.value);
    }
}

function startRunning(){
    running = true;
    
    startB.textContent = "Stop";
    startB.id = "stop";
    startB.onclick = stopRunning;
    
    run();
}

function stopRunning(){
    clearTimeout(curTimer);
    running = false;
    
    startB.textContent = "Start";
    startB.id = "start";
    startB.onclick = startRunning;
}

function apply(){
    newBoxes.clear();

    let str = String(eq.value);
    str = str.includes("return")? str : `return (${str});`;
    
    let func = Function("number, live, x, y, w, h", str);
    
    for (let num = 1, y = 0; y < numH; y++) {
        for (let x = 0; x < numW; x++, num++) {
            try {
                if (func(num, boxes.has(`${x} ${y}`), x, y, numW-1, numH-1) && isIn(x, y, 0, 0, numW-1, numH-1)) {
                    newBoxes.set(`${x} ${y}`, {x: x, y: y})
                }
            } catch (err) {
                console.error(err);
            }
        }
    }

    [boxes, newBoxes] = [newBoxes, boxes];
    
    drawBoxes();
}

document.addEventListener("keyup", function(event){
    if(event.target !== eq){
        event.target.blur();

        let key = event.key.toLowerCase();
        
        for(let i = 0; i < buttons.length; i++){
            if(buttons[i].id[0].toLowerCase() === key){
                buttons[i].click();
                break;
            }
        }

        if(key === "t"){
            eq.focus();
        }
    }
});


nextB.addEventListener("click", next);
randB.addEventListener("click", rand);
clearB.addEventListener("click", clear);
startB.onclick = startRunning;
applyB.addEventListener("click", apply);

drawBoxes();
        </script>
    </body>
</html>
